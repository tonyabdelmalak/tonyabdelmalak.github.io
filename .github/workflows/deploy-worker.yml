name: Deploy Cloudflare Worker

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Make your CF secrets available to all steps
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      # Optional, but useful for echo/debug. Keep if you created it as a secret.
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Show repo + wrangler.toml (debug)
        run: |
          pwd
          ls -la
          echo "----- wrangler.toml -----"
          cat wrangler.toml || true
          echo "-------------------------"

      - name: Install Wrangler (v4)
        run: |
          npm i -g wrangler@4
          wrangler --version

      - name: Wrangler whoami (CLI)
        run: |
          echo "Account (if provided): ${CLOUDFLARE_ACCOUNT_ID:-<none>}"
          wrangler whoami

      - name: Deploy Worker
        run: |
          # v4 uses `deploy` (not `publish`)
          wrangler deploy --verbose --config wrangler.toml
