Revert "Revert all changes made after commit ba02e2e"

This reverts commit ba02e2e and all subsequent changes.